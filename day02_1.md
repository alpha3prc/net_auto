---
marp: true
theme: gaia
class: lead
size: 16:9
paginate: true
---
# **forking编程**

---

## **案例1:单进程,单线程 ping**
1. 通过ping测试主机是否可达到
2. 若ping不同则认为无论什么原因都认为主机不可用
3. 需要通过ping的方式,扫面主机所在网段

- ip在哪个网段? :  

  `ip a s` 查看inet后面地址

---

- 参考代码:

```python
import subprocess

def ping(host):
  result = subprocess.run(
      'ping -c2 %s &> /dev/null' % host, shell=True
  )
  if result.returncode == 0:
      print('%s:up' % host)
  else:
      print('%s:down' % host)

if __name__ == '__main__':
  ips = ['192.168.113.%s' % i for i in range(1, 255)]
  for ip in ips:
      ping(ip)
```

---

## **forking 编程基本思路**

*   需要使用 os 模块
*   os.fork() 函数实现 forking 功能
*   python 中，绝大多数的函数只返回一次，os.fork 将返回两次
*   对 fork() 的调用，针对父进程返回子进程的PID；对于子进程，返回 PID 0

---
<!-- _class: cols-2 -->
### 简单示例1:

```python
import os

print('starting...')
ret_val = os.fork()
print('Hello World!')
```
---

### 简单示例2:

```python
import os

print('starting')
ret_val = os.fork()
if ret_val:  # 值非0为真
    print('in parent')
else:
    print('in child')

print('Done')
```
---

## **案例2：forking 基础应用**

*   编写一个 forking 脚本
    1.  在父进程中打印 "In parent" 然后睡眠 10 秒
    2.  在子进程中编写循环，循环 5 次，输出当前系统时间，每次循环结束后睡眠 1 秒
    3.  父子进程结束后，分别打印 "parent exit" 和 "child exit"

---

<!-- _class: lead -->

# 练习时间
---

## **小结**

- 多进程工作原理
- 多进程编程
