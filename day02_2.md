---
marp: true
theme: gaia
size: 16:9
paginate: true
---
# **02**

- 多进程应用

---

<!-- _class: lead -->

# **<u>多进程编程思路</u>**

---

### **多进程编程思路**

*   父进程负责生成子进程
*   子进程做具体的工作
*   子进程结束后彻底退出

---

讲解: [图例](https://upload-images.jianshu.io/upload_images/12347101-bc5e84e92e23c692.jpg?imageMogr2/auto-orient/strip|imageView2/2/format/webp)

**示例myfork3:**

```python
import os

print('staring')

for i in range(3):
    ret_val=os.fork()
    if not ret_val:  #0-f !0-->t
        print('Hello World!')
        exit()
```

---

## **案例3：扫描存活主机**

1.  通过 ping 测试主机是否可达
2.  如果 ping 不通，不管什么原因都认为主机不可用
3.  需要通过 ping 的方式，扫描您主机所在网段的所有 IP 地址
4.  通过 fork 方式实现并发扫描

---

<!-- _class: lead -->

# **僵尸进程问题**

---

## **僵尸进程**

*   僵尸进程没有任何可执行代码，也不能被调度
*   如果系统中存在过多的僵尸进程，将因为没有可用的进程号而导致系统不能产生新的进程
*   对于系统管理员来说，可以试图杀死其父进程或重启系统来消除僵尸进程

---

示例zb.py:

```python
import os
import time

print('starting')

ret_val=os.fork()
if ret_val:
    print('in parent')
    time.sleep(30)
    print('parent done')
else:
    print('in child')
    time.sleep(15)
    print('child done')
```

---

- 查看当前进程:

  `ps a`

- 每秒查看一次当前进程

  `watch -n1 ps a`
  
- 创建一个nano进程

  `nano &`

---

- 安装ps工具

  `apt-get install psmisc`

- 查看进程树

  `pstree`

---

## **解决 zombie 问题**

*   父进程通过 os.wait() 来得到子进程是否终止的信息
*   在子进程终止和父进程调用 wait() 之间的这段时间，子进程被称为 zombie (僵尸) 进程
*   如果子进程还没有终止，父进程先退出了，那么子进程会持续工作。系统自动将子进程的父进程设置为 init 进程，init 将来负责清理僵尸进程

---

## **解决 zombie 问题 (续1)**

*   python 可以使用 waitpid() 来处理子进程
*   waitpid() 接受两个参数，第一个参数设置为 -1，表示与 wait() 函数相同；第二个参数如果设置为 0 表示挂起父进程，直到子程序退出，设置为 1 表示不挂起父进程
*   waitpid() 的返回值：如果子进程尚未结束则返回 0，否则返回子进程的 PID

---

示例zb2.py

```python
import os
import time

print('starting')
ret_val = os.fork()
if ret_val:
    print('in parent')
    result = os.waitpid(-1, 0)
    print(result) # result是元组: (子进程pid, 0)
    time.sleep(3)
    print('parent done')
else:
    print('in child')
    time.sleep(5)
    print('child done')
```

---

## **案例4：理解僵尸进程**

1.  通过代码了解僵尸进程
2.  父进程和子进程同时进入睡眠
3.  子进程结束睡眠，成为僵尸进程
4.  父进程仍然处于睡眠状态一段时间，观察杀死子进程和父进程的结果
5.  通过 waitpid() 函数处理僵尸进程

---

<!-- _class: lead -->

# **练习时间**

---

# **小结**

- 多进程编程思路

- 僵尸进程
