---
marp: true
theme: gaia
size: 16:9
headingDivider: [2,3]
paginate: true
---
# 05
- urllib应用

## url进阶
<!-- _class: lead -->

## 模拟客户端

*   有些网页为了防止别人恶意采集其信息所以进行了一些反爬虫的设置，而我们又想进行爬取
*   可以设置一些Headers信息（User-Agent），模拟成浏览器去访问这些网站

```python
import urllib.request
url='http://www.tedu.cn'
hearder={
 'User-Agent':'Mozilla/5.0 (X11; Fedora; Linux x86_64)
AppleWebKit/537.36 (KHTML, like Gecko)
Chrome/58.0.3029.110 Safari/537.36'
}
html=urllib.request.Request(url,headers=header)
data=urllib.request.urlopen(request).read()
```

### 示例代码:

```python
url = 'http://www.jianshu.com'
from urllib import request
r = request.urlopen(url)
```

#### 加入header

```python
headers = {'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0'}
r = request.Request(url, headers=headers)
```

## 数据编码

*   一般来说, URL标准中只会允许一部分ASCII字符, 比如数字、字母、部分符号等
*   而其他的一些字符, 比如汉字等, 是不符合URL标准的。此时, 我们需要编码。
*   如果要进行编码, 可以使用`urllib.request.quote()`进行

```python
>>> urllib.request.quote('hello world!')
'hello%20world%21'
>>> urllib.request.unquote('hello%20world%21')
'hello world!'
```

### 示例
```python
>>> url = 'https://www.sogou.com/web?query=' + request.quote('中国')
>>> url
'https://www.sogou.com/web?query=%E4%B8%AD%E5%9B%BD'
>>> r = request.urlopen(url)
>>> url = 'https://www.sogou.com/web?query=' + request.quote('北京')
>>> url
'https://www.sogou.com/web?query=%E5%8C%97%E4%BA%AC'
```

## HTTP异常处理

*   如果访问的页面不存在或拒绝访问, 程序将抛出异常
*   捕获异常需要导入`urllib.error`模块

```python
>>> html = urllib.request.urlopen('http://172.40.50.116/a.html')
urllib.error.HTTPError: HTTP Error 404: Not Found
>>> html = urllib.request.urlopen('http://172.40.50.116/aaa')
urllib.error.HTTPError: HTTP Error 403: Forbidden
```

### 示例
```bash
rpm -q httpd
sudo apt install http
sudo apt install apache2 -y
ls /var/www/html
cd /var/www/html
mkdir ban
sudo chmod 000 /var/www/html/ban
```

### 示例weberror.py
```python
from urllib import request, error

url1 = 'http://127.0.0.1/abc'
url2 = 'http://127.0.0.1/ban'

try:
    r1 = request.urlopen(url1)
except error.HTTPError as e:
    print('错误:', e)

try:
    r2 = request.urlopen(url2)
except error.HTTPError as e:
    print('错误:', e)
```

## 案例8: 处理下载错误

1.  启动一个web服务
2.  在web服务器的文档目录下创建目录`ban`, 权限设置为700
3.  编写python程序访问不存在的路径和`ban`目录, 处理404和403错误
4.  404错误打印“无此页面”, 403错误打印“无权访问”

## 小结

*   修改请求头
*   字符编码