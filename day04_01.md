---
marp: true
theme: gaia
size: 16:9
headingDivider: [2,3]
paginate: true
---

# 06
- paramiko模块应用

## **paramiko**
<!-- _class: lead -->



## **安装paramiko模块**

*   **本地安装**

    ```bash
    # apt install -y gcc gcc-c++ python-devel
    # tar xzf paramiko-1.15.4.tar.gz
    # python setup.py install
    ```

*   **网络安装**

    ```bash
    # pip install paramiko
    ```



## **基础使用介绍**
*   **SSHClient**
    创建用于连接ssh服务器的实例
    ```python
    >>> ssh = paramiko.SSHClient()
    ```
*   **paramiko.AutoAddPolicy**
    设置自动添加主机密钥
*   **ssh.connect**
    连接ssh服务器
*   **ssh.exec\_comand**
    在ssh服务器上执行指定命令


## ssh回顾
```bash
ssh 127.0.0.1
#密钥认证过程
#认证原理
cat ~/.ssh/known_hosts
```

## **paramiko实例**

*   **编写用于实现ssh访问的脚本**
    *   创建SSHClient实例
    *   设置添加主机密钥策略
    *   连接ssh服务器
    *   执行指定命令
    *   在shell命令行中接受用于连接远程服务器的密码以及在远程主机上执行的命令

## 示例
```python
>>>import paramiko
>>>ssh = paramiko.SSHClient()
>>>ssh.connect('127.0.0.1')
>>>ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
>>>ssh.connect('127.0.0.1')
>>>ssh.connect('127.0.0.1', user='root', password='redhat')
>>>ssh.connect('127.0.0.1', username='root', password='redhat')
>>>ssh.exec_command('id root; id zhangsan')
>>>result = ssh.exec_command('id root; id zhangsan')
```

## 续接
```python
>>>result
>>>len(result)
>>>result[0]
>>>result[1]
>>>result[2]
#输入输出的类文件对象
>>>out=result[1].read()
>>>err=result[2].read()
>>>out
>>>err
>>>out.decode()
>>>err.decode()
>>>ssh.close()
```


## 修改rcmd示例
```python
if __name__ == '__main__':
    # rcmd('127.0.0.1', 'root', 'redhat', cmds='id root; id zhangsan')
    ips = ['127.0.0.1', '127.0.0.1', '127.0.0.1']
    for ip in ips:
        rcmd(ip, 'root', 'redhat', cmds='sleep 3; id root')
```

## **案例9：多线程ssh并发访问**

*   **编写脚本程序**
    1.  在文件中取出所有远程主机IP地址
    2.  在shell命令行中接受远程服务器IP地址文件、远程服务器密码以及在远程主机上执行的命令
    3.  通过多线程实现在所有的远程服务器上并发执行命令


## 传递参数
```bash
python rcmd.py servers.txt 'sleep 3; id root'
```
```python
if len(sys.argv) != 3:
    print("Usage: %s ipfile 'commands'" % sys.argv[0])
    exit(1)
if not os.path.isfile(sys.argv[1]):
    print('No such file:', sys.argv[1])
    exit(2)
ipfile = sys.argv[1]
passwd = getpass.getpass()
cmds = sys.argv[2]
```

## 多线程
```python
if __name__ == '__main__':
    # rcmd('127.0.0.1', 'root', 'redhat', cmds='id root; id zhangsan')
    # ips = ['127.0.0.1', '127.0.0.1', '127.0.0.1']
    # for ip in ips:
    # rcmd(ip, 'root', 'redhat', cmds='sleep 3; id root')
    if len(sys.argv) != 3:
        print("Usage: %s ipfile 'commands'" % sys.argv[0])
        exit(1)
    if not os.path.isfile(sys.argv[1]):
        print('No such file:', sys.argv[1])
        exit(2)

    ipfile = sys.argv[1]
    passwd = getpass.getpass()
    cmds = sys.argv[2]

    with open(ipfile) as fobj:
        for line in fobj:
            ip = line.strip() # 将文件结尾的\n移除
            t = threading.Thread(target=rcmd, args=(ip, 'root', 'redhat', 22, cmds))
            t.start()
```